<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0d0d18">
<title>HarmonyLab</title>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
  --bg:#0d0d18;--surface:#151522;--surface2:#1c1c2e;--surface3:#232338;
  --border:#2e2e4a;--accent:#7c5cfc;--accent2:#fc5c9c;--accent3:#3ee8c2;
  --text:#f0f0fa;--dim:#7070a0;--dim2:#9090b8;
  --green:#3ee87a;--red:#f06060;--yellow:#fbbf24;
  --r:16px;--rr:20px;--safe-bottom:env(safe-area-inset-bottom,0px);
}
html,body{width:100%;height:100%;background:var(--bg);color:var(--text);
  font-family:'Nunito',sans-serif;overflow:hidden;-webkit-font-smoothing:antialiased;}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background:radial-gradient(ellipse 70% 50% at 15% 0%,rgba(124,92,252,.12) 0%,transparent 55%),
             radial-gradient(ellipse 50% 60% at 85% 100%,rgba(252,92,156,.08) 0%,transparent 55%);}

/* ‚îÄ‚îÄ‚îÄ SCROLLABLE PAGE ‚îÄ‚îÄ‚îÄ */
.page{position:fixed;inset:0 0 calc(64px + var(--safe-bottom)) 0;
  overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;z-index:1;}
.page-inner{padding:14px 14px 28px;max-width:600px;margin:0 auto;}

/* ‚îÄ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ‚îÄ */
#loginScreen{position:fixed;inset:0;z-index:300;background:var(--bg);
  display:flex;align-items:center;justify-content:center;padding:24px;}
.login-wrap{width:100%;max-width:420px;}
.login-brand{text-align:center;margin-bottom:36px;}
.login-icon{width:76px;height:76px;border-radius:24px;margin:0 auto 16px;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  display:flex;align-items:center;justify-content:center;font-size:34px;
  box-shadow:0 10px 40px rgba(124,92,252,.4);}
.login-title{font-size:30px;font-weight:900;letter-spacing:-.5px;
  background:linear-gradient(135deg,var(--text),var(--accent));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.login-sub{font-size:13px;color:var(--dim);font-family:'JetBrains Mono',monospace;margin-top:5px;}

.inp{width:100%;background:var(--surface2);border:1.5px solid var(--border);
  border-radius:var(--r);padding:15px 18px;color:var(--text);
  font-family:'Nunito',sans-serif;font-size:16px;font-weight:600;outline:none;
  transition:border-color .2s,box-shadow .2s;margin-bottom:12px;}
.inp:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(124,92,252,.15);}

.btn-p{width:100%;padding:17px;border-radius:var(--r);border:none;
  background:linear-gradient(135deg,var(--accent),#9b6dff);color:#fff;
  font-family:'Nunito',sans-serif;font-size:17px;font-weight:900;cursor:pointer;
  box-shadow:0 6px 28px rgba(124,92,252,.38);letter-spacing:.02em;min-height:56px;
  transition:transform .12s;}
.btn-p:active{transform:scale(.97);}
.btn-s{width:100%;padding:15px;border-radius:var(--r);background:var(--surface2);
  border:1.5px solid var(--border);color:var(--dim2);font-family:'Nunito',sans-serif;
  font-size:16px;font-weight:700;cursor:pointer;margin-top:10px;min-height:52px;transition:border-color .2s;}
.btn-s:active{border-color:var(--accent);}
.fsep{display:flex;align-items:center;gap:10px;margin:14px 0;color:var(--dim);
  font-size:12px;font-family:'JetBrains Mono',monospace;}
.fsep::before,.fsep::after{content:'';flex:1;height:1px;background:var(--border);}
.ferr{font-size:13px;color:var(--red);font-family:'JetBrains Mono',monospace;
  margin-top:8px;min-height:20px;text-align:center;}

/* ‚îÄ‚îÄ‚îÄ APP ‚îÄ‚îÄ‚îÄ */
#appScreen{display:none;width:100%;height:100%;position:relative;z-index:1;}

/* ‚îÄ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ‚îÄ */
.topbar{position:sticky;top:0;z-index:50;
  background:rgba(13,13,24,.93);backdrop-filter:blur(18px);
  border-bottom:1px solid var(--border);
  padding:10px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px;}
.topbar-l{display:flex;align-items:center;gap:10px;}
.av{width:40px;height:40px;border-radius:13px;flex-shrink:0;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  display:flex;align-items:center;justify-content:center;font-size:17px;font-weight:900;color:#fff;}
.uname{font-size:15px;font-weight:800;line-height:1.2;}
.urole{font-size:11px;color:var(--dim);font-family:'JetBrains Mono',monospace;margin-top:1px;}
.adm-badge{background:rgba(251,191,36,.15);border:1px solid rgba(251,191,36,.4);
  color:var(--yellow);font-family:'JetBrains Mono',monospace;font-size:9px;
  padding:2px 6px;border-radius:5px;text-transform:uppercase;font-weight:700;margin-left:5px;}
.btn-out{background:none;border:1.5px solid var(--border);border-radius:10px;
  padding:9px 14px;color:var(--dim);font-size:13px;font-family:'JetBrains Mono',monospace;
  cursor:pointer;min-height:42px;font-weight:600;transition:all .2s;}
.btn-out:active{border-color:var(--red);color:var(--red);}

/* ‚îÄ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ‚îÄ */
.bnav{position:fixed;bottom:0;left:0;right:0;z-index:50;
  background:rgba(13,13,24,.97);backdrop-filter:blur(20px);
  border-top:1px solid var(--border);
  display:grid;grid-template-columns:repeat(4,1fr);
  padding-bottom:var(--safe-bottom);
  height:calc(64px + var(--safe-bottom));}
.nbtn{display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:3px;border:none;background:none;cursor:pointer;padding:8px 4px;color:var(--dim);
  transition:color .2s;min-height:56px;}
.nbtn.active{color:var(--accent);}
.nbtn .ico{font-size:22px;line-height:1;}
.nbtn .lbl{font-size:10px;font-weight:700;font-family:'JetBrains Mono',monospace;
  text-transform:uppercase;letter-spacing:.04em;}

/* ‚îÄ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ */
.tab{display:none;}
.tab.active{display:block;animation:fadeUp .18s ease;}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

/* ‚îÄ‚îÄ‚îÄ LABELS ‚îÄ‚îÄ‚îÄ */
.slbl{font-size:10px;letter-spacing:.35em;text-transform:uppercase;color:var(--accent);
  font-family:'JetBrains Mono',monospace;margin-bottom:8px;font-weight:600;}
.stitle{font-size:20px;font-weight:900;letter-spacing:-.3px;margin-bottom:14px;}

/* ‚îÄ‚îÄ‚îÄ CARD ‚îÄ‚îÄ‚îÄ */
.card{background:var(--surface);border:1px solid var(--border);
  border-radius:var(--rr);padding:18px;margin-bottom:12px;}

/* ‚îÄ‚îÄ‚îÄ DROPZONE ‚îÄ‚îÄ‚îÄ */
.dropzone{border:2px dashed var(--border);border-radius:var(--r);
  padding:30px 20px;text-align:center;cursor:pointer;transition:all .25s;
  position:relative;overflow:hidden;}
.dropzone.over{border-color:var(--accent);background:rgba(124,92,252,.06);}
.dropzone input{position:absolute;inset:0;opacity:0;cursor:pointer;font-size:0;}
.dz-ico{font-size:46px;margin-bottom:10px;}
.dz-t{font-size:17px;font-weight:900;color:var(--text);margin-bottom:4px;}
.dz-s{font-size:13px;color:var(--dim);}
.fname-b{margin-top:12px;font-family:'JetBrains Mono',monospace;font-size:11px;
  color:var(--accent3);background:rgba(62,232,194,.1);padding:6px 14px;
  border-radius:8px;display:none;border:1px solid rgba(62,232,194,.2);}
.upbar-w{height:5px;background:var(--border);border-radius:3px;overflow:hidden;margin-top:10px;display:none;}
.upbar{height:100%;width:0%;background:linear-gradient(to right,var(--accent),var(--accent3));transition:width .2s;border-radius:3px;}
.up-ok{font-size:12px;color:var(--accent3);font-family:'JetBrains Mono',monospace;margin-top:8px;display:none;text-align:center;}

/* listener progress */
.lup{background:rgba(124,92,252,.08);border:1px solid rgba(124,92,252,.22);
  border-radius:var(--r);padding:14px 16px;margin-bottom:12px;display:none;}
.lup-row{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
.lup-dot{width:8px;height:8px;border-radius:50%;background:var(--accent);animation:pulse 1s infinite;flex-shrink:0;}
.lup-name{font-size:13px;font-weight:800;color:var(--accent);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.lup-bg{height:5px;background:var(--border);border-radius:3px;overflow:hidden;}
.lup-bar{height:100%;width:0%;background:linear-gradient(to right,var(--accent),var(--accent3));border-radius:3px;transition:width .3s;}
.lup-pct{font-size:11px;color:var(--dim);font-family:'JetBrains Mono',monospace;text-align:right;margin-top:4px;}

/* listener box */
.list-box{background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:18px;text-align:center;}
.aud-wait{font-size:14px;color:var(--dim2);font-family:'JetBrains Mono',monospace;padding:8px 0;}
audio{width:100%;border-radius:10px;margin-top:6px;}

/* waveform */
.ww{height:58px;margin:10px 0;background:rgba(255,255,255,.02);border-radius:12px;overflow:hidden;display:none;}
canvas.wv{width:100%;height:100%;display:block;}

/* status */
.sbar{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--dim);
  font-family:'JetBrains Mono',monospace;background:rgba(255,255,255,.02);
  border-radius:10px;padding:10px 14px;margin-top:10px;}
.sbar .dot{width:7px;height:7px;border-radius:50%;background:var(--dim);flex-shrink:0;}
.sbar.proc .dot{background:var(--accent);animation:pulse 1s infinite;}
.sbar.ok .dot{background:var(--accent3);}

/* history */
.hist-hdr{display:flex;align-items:center;justify-content:space-between;margin:16px 0 8px;}
.hist-t{font-size:14px;font-weight:800;color:var(--dim2);}
.aitem{display:flex;align-items:center;gap:10px;background:var(--surface2);
  border:1px solid var(--border);border-radius:14px;padding:12px 14px;margin-bottom:8px;}
.aitem-info{flex:1;min-width:0;}
.aitem-name{font-size:14px;font-weight:800;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.aitem-by{font-size:11px;color:var(--dim);font-family:'JetBrains Mono',monospace;margin-top:2px;}
.abadge{background:rgba(62,232,194,.12);border:1px solid rgba(62,232,194,.3);
  color:var(--accent3);font-family:'JetBrains Mono',monospace;font-size:9px;
  font-weight:700;padding:3px 7px;border-radius:6px;flex-shrink:0;}
.btn-use{background:rgba(124,92,252,.15);border:1.5px solid rgba(124,92,252,.35);
  border-radius:10px;padding:9px 13px;color:var(--accent);font-size:13px;
  font-weight:800;cursor:pointer;flex-shrink:0;min-height:42px;min-width:58px;
  font-family:'Nunito',sans-serif;}
.btn-use:active{background:rgba(124,92,252,.3);}
.btn-del{background:none;border:1.5px solid var(--border);border-radius:10px;
  padding:9px 11px;color:var(--dim);font-size:15px;cursor:pointer;flex-shrink:0;min-height:42px;min-width:42px;}
.btn-del:active{border-color:var(--red);color:var(--red);}
.no-hist{font-size:13px;color:var(--dim);font-family:'JetBrains Mono',monospace;
  text-align:center;padding:18px;background:var(--surface2);border-radius:var(--r);}

/* ‚îÄ‚îÄ‚îÄ KEY GRID ‚îÄ‚îÄ‚îÄ */
.kgrid{display:grid;grid-template-columns:repeat(6,1fr);gap:6px;margin-bottom:12px;}
.kbtn{background:var(--surface2);border:1.5px solid var(--border);border-radius:12px;
  padding:13px 4px;text-align:center;cursor:pointer;transition:all .12s;min-height:54px;
  display:flex;flex-direction:column;align-items:center;justify-content:center;}
.kbtn:active{transform:scale(.93);}
.kbtn.active{border-color:var(--accent);background:rgba(124,92,252,.18);
  box-shadow:0 0 0 2px rgba(124,92,252,.2);}
.kbtn .n{font-size:16px;font-weight:900;color:var(--dim);}
.kbtn.active .n{color:var(--accent);}
.theory-box{background:var(--surface2);border-radius:12px;padding:12px 16px;
  font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--dim2);text-align:center;line-height:1.7;}

/* ‚îÄ‚îÄ‚îÄ CHANNEL CARDS ‚îÄ‚îÄ‚îÄ */
.ch{background:var(--surface);border:1px solid var(--border);border-radius:var(--rr);
  padding:18px;margin-bottom:12px;}
.ch.ch-f{border-color:rgba(124,92,252,.32);}
.ch.ch-t{border-color:rgba(252,92,156,.32);}
.ch.ch-5{border-color:rgba(62,232,194,.32);}
.ch-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
.ch-name{font-size:17px;font-weight:900;}
.ch-badge{font-family:'JetBrains Mono',monospace;font-size:10px;padding:4px 10px;border-radius:7px;font-weight:700;}
.ch-f .ch-badge{background:rgba(124,92,252,.18);color:var(--accent);}
.ch-t .ch-badge{background:rgba(252,92,156,.18);color:var(--accent2);}
.ch-5 .ch-badge{background:rgba(62,232,194,.18);color:var(--accent3);}
.ch-info{font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--dim);
  background:rgba(255,255,255,.03);border-radius:10px;padding:8px 12px;margin-bottom:14px;line-height:1.6;}
.ch-info b{font-weight:700;}
.ch-f .ch-info b{color:var(--accent);}
.ch-t .ch-info b{color:var(--accent2);}
.ch-5 .ch-info b{color:var(--accent3);}
.vol-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
.vol-lbl{font-size:12px;color:var(--dim);font-family:'JetBrains Mono',monospace;text-transform:uppercase;letter-spacing:.06em;}
.vol-val{font-size:14px;font-weight:900;font-family:'JetBrains Mono',monospace;}
input[type=range]{-webkit-appearance:none;width:100%;height:7px;border-radius:4px;outline:none;cursor:pointer;}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:26px;height:26px;border-radius:50%;border:3px solid var(--bg);cursor:pointer;}
#v0::-webkit-slider-thumb{background:var(--accent);}
#v1::-webkit-slider-thumb{background:var(--accent2);}
#v2::-webkit-slider-thumb{background:var(--accent3);}

/* ‚îÄ‚îÄ‚îÄ MASTER ‚îÄ‚îÄ‚îÄ */
.master{background:var(--surface);border:1px solid var(--border);border-radius:var(--rr);
  padding:18px;margin-bottom:12px;}
.btn-all{width:100%;padding:19px;border-radius:var(--r);border:none;
  background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;
  font-family:'Nunito',sans-serif;font-size:19px;font-weight:900;cursor:pointer;
  display:flex;align-items:center;justify-content:center;gap:10px;
  box-shadow:0 6px 30px rgba(124,92,252,.38);min-height:62px;
  letter-spacing:.01em;margin-bottom:10px;transition:transform .12s;}
.btn-all:active{transform:scale(.97);}
.btn-all:disabled{opacity:.35;cursor:not-allowed;}
.btn-row2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.btn-stop{padding:16px;border-radius:var(--r);border:1.5px solid var(--border);
  background:var(--surface2);color:var(--dim2);font-family:'Nunito',sans-serif;
  font-size:15px;font-weight:800;cursor:pointer;min-height:54px;transition:border-color .2s;}
.btn-stop:active{border-color:var(--red);color:var(--red);}
.btn-exp{padding:16px;border-radius:var(--r);border:1.5px solid rgba(62,232,194,.35);
  background:rgba(62,232,194,.08);color:var(--accent3);font-family:'Nunito',sans-serif;
  font-size:15px;font-weight:800;cursor:pointer;min-height:54px;}
.btn-exp:disabled{opacity:.35;cursor:not-allowed;}
.btn-exp:active{background:rgba(62,232,194,.18);}

/* ‚îÄ‚îÄ‚îÄ CHAT ‚îÄ‚îÄ‚îÄ */
#tab-chat{padding:0;margin:-14px -14px 0;}
.chat-wrap{display:flex;flex-direction:column;height:calc(100vh - calc(64px + var(--safe-bottom)) - 61px);}
.chat-hdr{display:flex;align-items:center;justify-content:space-between;
  padding:14px 16px 12px;border-bottom:1px solid var(--border);
  background:rgba(13,13,24,.92);position:sticky;top:0;backdrop-filter:blur(14px);}
.chat-hdr-l{display:flex;align-items:center;gap:10px;}
.chat-htitle{font-size:17px;font-weight:900;}
.chat-online{font-size:11px;color:var(--green);font-family:'JetBrains Mono',monospace;font-weight:700;}
.btn-clr{background:none;border:1.5px solid var(--border);border-radius:9px;
  padding:7px 13px;color:var(--dim);font-size:12px;font-family:'JetBrains Mono',monospace;
  cursor:pointer;min-height:38px;font-weight:600;}
.btn-clr:active{border-color:var(--red);color:var(--red);}
.chat-msgs{flex:1;overflow-y:auto;padding:12px 16px;display:flex;flex-direction:column;
  gap:8px;-webkit-overflow-scrolling:touch;}
.msg{display:flex;flex-direction:column;gap:3px;}
.msg.mine{align-items:flex-end;}
.msg-meta{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);padding:0 4px;}
.msg-bubble{background:var(--surface2);border:1px solid var(--border);
  border-radius:16px 16px 16px 4px;padding:11px 15px;font-size:15px;
  line-height:1.5;max-width:82%;word-break:break-word;font-weight:600;}
.msg.mine .msg-bubble{background:rgba(124,92,252,.17);border-color:rgba(124,92,252,.32);
  border-radius:16px 16px 4px 16px;}
.msg.system .msg-bubble{background:rgba(62,232,194,.06);border-color:rgba(62,232,194,.2);
  color:var(--accent3);font-family:'JetBrains Mono',monospace;font-size:11px;
  text-align:center;max-width:100%;border-radius:12px;}
.chat-inp-area{padding:10px 14px calc(12px + var(--safe-bottom));border-top:1px solid var(--border);
  background:var(--bg);display:flex;gap:10px;align-items:flex-end;}
.chat-inp{flex:1;background:var(--surface2);border:1.5px solid var(--border);border-radius:14px;
  padding:13px 16px;color:var(--text);font-family:'Nunito',sans-serif;font-size:15px;
  font-weight:600;outline:none;resize:none;line-height:1.4;max-height:100px;transition:border-color .2s;}
.chat-inp:focus{border-color:var(--accent);}
.btn-send{background:var(--accent);border:none;border-radius:14px;width:50px;height:50px;
  min-width:50px;display:flex;align-items:center;justify-content:center;cursor:pointer;
  box-shadow:0 4px 18px rgba(124,92,252,.38);flex-shrink:0;}
.btn-send svg{width:19px;height:19px;fill:#fff;}

/* ‚îÄ‚îÄ‚îÄ USERS ‚îÄ‚îÄ‚îÄ */
.ulist{display:flex;flex-direction:column;gap:8px;}
.urow{display:flex;align-items:center;gap:12px;background:var(--surface2);
  border:1px solid var(--border);border-radius:16px;padding:14px;}
.uav{width:44px;height:44px;border-radius:14px;flex-shrink:0;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:900;color:#fff;}
.unm{font-size:15px;font-weight:800;flex:1;}
.ust{font-family:'JetBrains Mono',monospace;font-size:10px;padding:4px 9px;border-radius:6px;font-weight:700;}
.st-on{background:rgba(62,232,122,.1);border:1px solid rgba(62,232,122,.3);color:var(--green);}
.st-off{background:rgba(112,112,160,.1);border:1px solid rgba(112,112,160,.2);color:var(--dim);}

/* ‚îÄ‚îÄ‚îÄ OVERLAY ‚îÄ‚îÄ‚îÄ */
.overlay{display:none;position:fixed;inset:0;background:rgba(10,10,20,.93);
  backdrop-filter:blur(14px);z-index:200;align-items:center;justify-content:center;
  flex-direction:column;gap:18px;padding:32px;}
.overlay.show{display:flex;}
.spin{width:52px;height:52px;border:3px solid var(--border);border-top-color:var(--accent);
  border-radius:50%;animation:spin .8s linear infinite;}
.ov-t{font-family:'JetBrains Mono',monospace;font-size:14px;color:var(--accent);
  font-weight:600;text-align:center;}
.ov-bw{width:min(280px,80vw);height:5px;background:var(--border);border-radius:3px;overflow:hidden;}
.ov-b{height:100%;width:0%;background:linear-gradient(to right,var(--accent),var(--accent2));
  transition:width .3s;border-radius:3px;}
.ov-p{font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--dim);}

@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
@keyframes spin{to{transform:rotate(360deg)}}
::-webkit-scrollbar{width:3px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
</style>
</head>
<body>

<!-- OVERLAY -->
<div class="overlay" id="overlay">
  <div class="spin"></div>
  <div class="ov-t" id="ptxt">Processando...</div>
  <div class="ov-bw"><div class="ov-b" id="pbar"></div></div>
  <div class="ov-p" id="pct"></div>
</div>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="login-wrap">
    <div class="login-brand">
      <div class="login-icon">üéµ</div>
      <div class="login-title">HarmonyLab</div>
      <div class="login-sub">Sala Colaborativa ¬∑ v4.0</div>
    </div>
    <div id="loginForm">
      <input class="inp" id="emailIn" type="email" placeholder="E-mail" autocomplete="email">
      <input class="inp" id="passIn" type="password" placeholder="Senha" autocomplete="current-password">
      <button class="btn-p" id="loginBtn">Entrar</button>
      <div class="fsep">ou</div>
      <button class="btn-s" id="showRegBtn">Criar conta</button>
      <div class="ferr" id="loginErr"></div>
    </div>
    <div id="registerForm" style="display:none">
      <input class="inp" id="regName" type="text" placeholder="Seu nome" autocomplete="name">
      <input class="inp" id="regEmail" type="email" placeholder="E-mail" autocomplete="email">
      <input class="inp" id="regPass" type="password" placeholder="Senha (m√≠n. 6 caracteres)">
      <button class="btn-p" id="regBtn">Criar conta</button>
      <div class="fsep">ou</div>
      <button class="btn-s" id="showLoginBtn">Voltar ao login</button>
      <div class="ferr" id="regErr"></div>
    </div>
  </div>
</div>

<!-- APP -->
<div id="appScreen">

  <!-- TOP BAR -->
  <div class="topbar">
    <div class="topbar-l">
      <div class="av" id="userAvatar">?</div>
      <div>
        <div class="uname" id="userNameDisplay">‚Äî<span class="adm-badge" id="adminBadge" style="display:none">Admin</span></div>
        <div class="urole" id="userEmailDisplay">‚Äî</div>
      </div>
    </div>
    <button class="btn-out" id="logoutBtn">Sair</button>
  </div>

  <!-- SCROLLABLE PAGE -->
  <div class="page" id="mainPage">
    <div class="page-inner">

      <!-- TAB: √ÅUDIO -->
      <div class="tab active" id="tab-audio">

        <!-- ADMIN -->
        <div id="adminAudioSection" style="display:none">
          <div class="slbl">√Åudio</div>
          <div class="card">
            <div class="dropzone" id="dz">
              <input type="file" id="fileIn" accept="audio/*">
              <div class="dz-ico">üéô</div>
              <div class="dz-t">Toque para carregar</div>
              <div class="dz-s">MP3 ¬∑ WAV ¬∑ OGG ¬∑ M4A ¬∑ FLAC</div>
              <div class="fname-b" id="fname"></div>
            </div>
            <div class="upbar-w" id="uploadBarWrap"><div class="upbar" id="uploadBar"></div></div>
            <div class="up-ok" id="uploadStatus">‚úì √Åudio enviado para todos</div>
          </div>
          <div class="ww" id="ww"><canvas class="wv" id="wvc"></canvas></div>
          <div class="sbar" id="status"><span class="dot"></span><span>Aguardando √°udio...</span></div>
          <div class="hist-hdr"><div class="hist-t">üéµ √Åudios Armazenados</div></div>
          <div id="audioHistoryList"></div>
        </div>

        <!-- LISTENER -->
        <div id="listenerAudioSection" style="display:none">
          <div class="slbl">√Åudio</div>
          <div class="lup" id="listenerUploadProgress">
            <div class="lup-row">
              <span class="lup-dot"></span>
              <span class="lup-name" id="lup-name">Admin enviando...</span>
            </div>
            <div class="lup-bg"><div class="lup-bar" id="lupBar"></div></div>
            <div class="lup-pct" id="lupPct">0%</div>
          </div>
          <div class="list-box">
            <div class="aud-wait" id="audioReadyMsg">‚è≥ Aguardando √°udio do administrador...</div>
            <audio id="remoteAudio" controls style="display:none"></audio>
          </div>
          <div class="ww" id="ww2"><canvas class="wv" id="wvc2"></canvas></div>
          <div class="sbar" id="status2"><span class="dot"></span><span>Aguardando √°udio...</span></div>
          <div class="hist-hdr"><div class="hist-t">üéµ √Åudios Dispon√≠veis</div></div>
          <div id="listenerHistoryList"></div>
        </div>

      </div><!-- /tab-audio -->

      <!-- TAB: VOZES -->
      <div class="tab" id="tab-voices">

        <div class="slbl">Tom Global</div>
        <div class="card" style="border-color:rgba(124,92,252,.28);margin-bottom:14px;">
          <div class="stitle">Nota Fundamental</div>
          <div class="kgrid" id="kg"></div>
          <div class="theory-box" id="theory">Selecione uma nota para ver as harmonias</div>
        </div>

        <div class="slbl" style="margin-top:4px;">Canais</div>

        <div class="ch ch-f">
          <div class="ch-head"><span class="ch-name">Original</span><span class="ch-badge">FUNDAMENTAL</span></div>
          <div class="ch-info" id="pi0">Tom: <b id="nd0">‚Äî</b> &nbsp;¬∑&nbsp; <b id="st0">0 st</b></div>
          <div class="vol-row"><span class="vol-lbl">Volume</span><span class="vol-val" id="vd0">100%</span></div>
          <input type="range" id="v0" min="0" max="150" value="100">
        </div>

        <div class="ch ch-t">
          <div class="ch-head"><span class="ch-name">Segunda Voz</span><span class="ch-badge">3¬™ MAIOR</span></div>
          <div class="ch-info" id="pi1">Tom: <b id="nd1">‚Äî</b> &nbsp;¬∑&nbsp; <b id="st1">+4 st</b></div>
          <div class="vol-row"><span class="vol-lbl">Volume</span><span class="vol-val" id="vd1">80%</span></div>
          <input type="range" id="v1" min="0" max="150" value="80">
        </div>

        <div class="ch ch-5">
          <div class="ch-head"><span class="ch-name">Quinta Voz</span><span class="ch-badge">5¬™ JUSTA</span></div>
          <div class="ch-info" id="pi2">Tom: <b id="nd2">‚Äî</b> &nbsp;¬∑&nbsp; <b id="st2">+7 st</b></div>
          <div class="vol-row"><span class="vol-lbl">Volume</span><span class="vol-val" id="vd2">80%</span></div>
          <input type="range" id="v2" min="0" max="150" value="80">
        </div>

        <div class="master">
          <div class="slbl">Mestre</div>
          <button class="btn-all" id="playAllBtn" disabled>‚ñ∂‚ñ∂ Tocar Tudo</button>
          <div class="btn-row2">
            <button class="btn-stop" id="stopBtn">‚ñ† Parar</button>
            <button class="btn-exp" id="expBtn" disabled>‚¨á Exportar</button>
          </div>
        </div>

      </div><!-- /tab-voices -->

      <!-- TAB: CHAT -->
      <div class="tab" id="tab-chat">
        <div class="chat-wrap">
          <div class="chat-hdr">
            <div class="chat-hdr-l">
              <div class="chat-htitle">üí¨ Chat</div>
              <div class="chat-online" id="chatOnlineCount"></div>
            </div>
            <button class="btn-clr" id="clearChatBtn">üóë Limpar</button>
          </div>
          <div class="chat-msgs" id="chatMsgs"></div>
          <div class="chat-inp-area">
            <textarea class="chat-inp" id="chatInput" rows="1" placeholder="Mensagem..."></textarea>
            <button class="btn-send" id="sendBtn">
              <svg viewBox="0 0 24 24"><path d="M2 21l21-9L2 3v7l15 2-15 2z"/></svg>
            </button>
          </div>
        </div>
      </div><!-- /tab-chat -->

      <!-- TAB: USU√ÅRIOS -->
      <div class="tab" id="tab-users">
        <div class="slbl">Usu√°rios Online</div>
        <div class="ulist" id="usersList"></div>
      </div>

    </div><!-- /page-inner -->
  </div><!-- /page -->

  <!-- BOTTOM NAV -->
  <nav class="bnav">
    <button class="nbtn active" data-tab="tab-audio">
      <span class="ico">üéô</span><span class="lbl">√Åudio</span>
    </button>
    <button class="nbtn" data-tab="tab-voices">
      <span class="ico">üéµ</span><span class="lbl">Vozes</span>
    </button>
    <button class="nbtn" data-tab="tab-chat">
      <span class="ico">üí¨</span><span class="lbl">Chat</span>
    </button>
    <button class="nbtn" data-tab="tab-users">
      <span class="ico">üë•</span><span class="lbl">Sala</span>
    </button>
  </nav>

</div><!-- /appScreen -->

<script>
/* ‚ïê‚ïê FIREBASE ‚ïê‚ïê */
const firebaseConfig={
  apiKey:"AIzaSyAZ3dBIKuYoenF3ddcdT36JbJXqaVdSwm0",
  authDomain:"harmoniadavoz-55191.firebaseapp.com",
  databaseURL:"https://harmoniadavoz-55191-default-rtdb.firebaseio.com",
  projectId:"harmoniadavoz-55191",
  storageBucket:"harmoniadavoz-55191.firebasestorage.app",
  messagingSenderId:"401239706920",
  appId:"1:401239706920:web:de5e57174237f53259d41d"
};
const ADMIN_EMAIL='romerson3d@gmail.com';
const CLOUDINARY_CLOUD='dc0ulekxw';
const CLOUDINARY_PRESET='do0snhuq';

firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(), db=firebase.database();
let currentUser=null,isAdmin=false,displayName='',onlineRef=null;

/* ‚ïê‚ïê BOTTOM NAV ‚ïê‚ïê */
document.querySelectorAll('.nbtn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const tid=btn.dataset.tab;
    document.querySelectorAll('.nbtn').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(p=>p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(tid).classList.add('active');
    document.getElementById('mainPage').scrollTo(0,0);
  });
});

/* ‚ïê‚ïê AUTH ‚ïê‚ïê */
document.getElementById('showRegBtn').onclick=()=>{
  document.getElementById('loginForm').style.display='none';
  document.getElementById('registerForm').style.display='block';
};
document.getElementById('showLoginBtn').onclick=()=>{
  document.getElementById('loginForm').style.display='block';
  document.getElementById('registerForm').style.display='none';
};
document.getElementById('loginBtn').onclick=async()=>{
  const email=document.getElementById('emailIn').value.trim();
  const pass=document.getElementById('passIn').value;
  document.getElementById('loginErr').textContent='';
  try{await auth.signInWithEmailAndPassword(email,pass);}
  catch(e){document.getElementById('loginErr').textContent=authErr(e.code);}
};
document.getElementById('regBtn').onclick=async()=>{
  const name=document.getElementById('regName').value.trim();
  const email=document.getElementById('regEmail').value.trim();
  const pass=document.getElementById('regPass').value;
  document.getElementById('regErr').textContent='';
  if(!name){document.getElementById('regErr').textContent='Informe seu nome.';return;}
  try{
    const c=await auth.createUserWithEmailAndPassword(email,pass);
    await c.user.updateProfile({displayName:name});
    await db.ref('users/'+c.user.uid).set({name,email,role:email===ADMIN_EMAIL?'admin':'user'});
  }catch(e){document.getElementById('regErr').textContent=authErr(e.code);}
};
document.getElementById('logoutBtn').onclick=()=>{if(onlineRef)onlineRef.remove();auth.signOut();};

auth.onAuthStateChanged(async user=>{
  if(user){
    currentUser=user; isAdmin=user.email===ADMIN_EMAIL;
    displayName=user.displayName||user.email.split('@')[0];
    await db.ref('users/'+user.uid).update({name:displayName,email:user.email,role:isAdmin?'admin':'user'});
    onlineRef=db.ref('presence/'+user.uid);
    onlineRef.set({name:displayName,email:user.email,online:true,lastSeen:firebase.database.ServerValue.TIMESTAMP});
    onlineRef.onDisconnect().update({online:false});
    showApp(); initApp();
  }else{
    currentUser=null;
    document.getElementById('loginScreen').style.display='flex';
    document.getElementById('appScreen').style.display='none';
  }
});

function showApp(){
  document.getElementById('loginScreen').style.display='none';
  document.getElementById('appScreen').style.display='block';
  document.getElementById('userAvatar').textContent=displayName[0].toUpperCase();
  document.getElementById('userNameDisplay').childNodes[0].textContent=displayName+' ';
  document.getElementById('userEmailDisplay').textContent=currentUser.email;
  if(isAdmin) document.getElementById('adminBadge').style.display='inline';
  if(isAdmin) document.getElementById('adminAudioSection').style.display='block';
  else        document.getElementById('listenerAudioSection').style.display='block';
}
function authErr(code){
  const m={'auth/user-not-found':'Usu√°rio n√£o encontrado.','auth/wrong-password':'Senha incorreta.',
    'auth/email-already-in-use':'E-mail j√° cadastrado.','auth/weak-password':'Senha fraca (m√≠n. 6 chars).',
    'auth/invalid-email':'E-mail inv√°lido.','auth/too-many-requests':'Muitas tentativas.',
    'auth/network-request-failed':'Sem conex√£o.'};
  return m[code]||'Erro: '+code;
}

/* ‚ïê‚ïê INIT ‚ïê‚ïê */
function initApp(){
  listenOnlineUsers(); listenChat(); listenAudioHistory();
  if(!isAdmin){listenAdminAudio();listenUploadProgress();}
}

/* ‚ïê‚ïê ONLINE USERS ‚ïê‚ïê */
function listenOnlineUsers(){
  db.ref('presence').on('value',snap=>{
    const data=snap.val()||{};
    const list=document.getElementById('usersList');
    const cnt=Object.values(data).filter(u=>u.online).length;
    document.getElementById('chatOnlineCount').textContent=cnt+' online';
    list.innerHTML='';
    Object.entries(data).forEach(([uid,u])=>{
      const row=document.createElement('div');
      row.className='urow';
      const ini=(u.name||u.email||'?')[0].toUpperCase();
      row.innerHTML=`<div class="uav">${ini}</div>
        <div class="unm">${u.name||u.email}</div>
        <div class="ust ${u.online?'st-on':'st-off'}">${u.online?'online':'offline'}</div>`;
      list.appendChild(row);
    });
  });
}

/* ‚ïê‚ïê CHAT ‚ïê‚ïê */
function listenChat(){
  const msgs=document.getElementById('chatMsgs');
  db.ref('chat').limitToLast(100).on('child_added',snap=>{
    const m=snap.val();
    const div=document.createElement('div');
    const isMe=m.uid===currentUser.uid, isSys=m.type==='system';
    div.className='msg'+(isMe?' mine':'')+(isSys?' system':'');
    const time=new Date(m.ts).toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
    div.innerHTML=isSys
      ?`<div class="msg-bubble">${m.text}</div>`
      :`<div class="msg-meta">${isMe?'voc√™':m.name} ¬∑ ${time}</div><div class="msg-bubble">${esc(m.text)}</div>`;
    msgs.appendChild(div); msgs.scrollTop=msgs.scrollHeight;
  });
}
function sendMsg(txt){
  if(!txt.trim())return;
  db.ref('chat').push({uid:currentUser.uid,name:displayName,email:currentUser.email,text:txt.trim(),ts:firebase.database.ServerValue.TIMESTAMP});
}
document.getElementById('sendBtn').onclick=()=>{
  const inp=document.getElementById('chatInput'); sendMsg(inp.value); inp.value='';
};
document.getElementById('chatInput').addEventListener('keydown',e=>{
  if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();document.getElementById('sendBtn').click();}
});
document.getElementById('clearChatBtn').onclick=()=>{
  if(confirm('Limpar mensagens da sua tela?')) document.getElementById('chatMsgs').innerHTML='';
};
function esc(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

/* ‚ïê‚ïê UPLOAD PROGRESS ‚ïê‚ïê */
function pubProg(pct,fn){db.ref('session/uploadProgress').set({pct,fileName:fn,ts:firebase.database.ServerValue.TIMESTAMP});}
function clrProg(){db.ref('session/uploadProgress').remove();}
function listenUploadProgress(){
  db.ref('session/uploadProgress').on('value',snap=>{
    const d=snap.val(), el=document.getElementById('listenerUploadProgress');
    if(d&&d.pct<100){
      el.style.display='block';
      document.getElementById('lup-name').textContent=`Recebendo: ${d.fileName||'√°udio'}`;
      document.getElementById('lupBar').style.width=d.pct+'%';
      document.getElementById('lupPct').textContent=d.pct+'%';
    }else{el.style.display='none';}
  });
}

/* ‚ïê‚ïê AUDIO HISTORY ‚ïê‚ïê */
function listenAudioHistory(){db.ref('audioHistory').on('value',snap=>renderHistory(snap.val()||{}));}
function renderHistory(data){
  const entries=Object.entries(data).sort((a,b)=>b[1].uploadedAt-a[1].uploadedAt);
  const render=(cid,adminView)=>{
    const c=document.getElementById(cid); if(!c)return;
    if(!entries.length){c.innerHTML='<div class="no-hist">Nenhum √°udio armazenado</div>';return;}
    c.innerHTML='';
    entries.forEach(([key,item])=>{
      const div=document.createElement('div'); div.className='aitem';
      div.innerHTML=`
        <div class="aitem-info">
          <div class="aitem-name" title="${esc(item.name)}">${esc(item.name)}</div>
          <div class="aitem-by">${item.uploadedBy||'?'}</div>
        </div>
        ${item.isActive?'<span class="abadge">ATIVO</span>':''}
        <button class="btn-use" onclick="${adminView?`activateAudio('${key}')`:`loadAudioFromUrl('${item.url}')`}">‚ñ∂ Usar</button>
        ${isAdmin?`<button class="btn-del" onclick="deleteAudio('${key}')">‚úï</button>`:''}
      `;
      c.appendChild(div);
    });
  };
  render('audioHistoryList',true); render('listenerHistoryList',false);
}
async function activateAudio(key){
  const snap=await db.ref('audioHistory/'+key).once('value'); const item=snap.val(); if(!item)return;
  const all=(await db.ref('audioHistory').once('value')).val()||{};
  const updates={};
  Object.keys(all).forEach(k=>{updates['audioHistory/'+k+'/isActive']=false;});
  updates['audioHistory/'+key+'/isActive']=true;
  await db.ref().update(updates);
  await db.ref('session').set({audioUrl:item.url,audioName:item.name,uploadedBy:item.uploadedBy,uploadedAt:firebase.database.ServerValue.TIMESTAMP});
  ensureActx();
  const ab=await(await fetch(item.url)).arrayBuffer();
  origBuf=await actx.decodeAudioData(ab); drawWave(origBuf); await doProc();
}
async function deleteAudio(key){if(!confirm('Excluir este √°udio?'))return; await db.ref('audioHistory/'+key).remove();}

/* ‚ïê‚ïê LISTEN ADMIN AUDIO ‚ïê‚ïê */
function listenAdminAudio(){
  db.ref('session/audioUrl').on('value',snap=>{
    const url=snap.val(); if(!url)return;
    document.getElementById('audioReadyMsg').style.display='none';
    const a=document.getElementById('remoteAudio'); a.style.display='block'; a.src=url;
    loadAudioFromUrl(url);
  });
}
async function loadAudioFromUrl(url){
  showOverlay(true,'Carregando √°udio...',5); setStatus('proc','Carregando...');
  ensureActx();
  try{
    const ab=await(await fetch(url)).arrayBuffer();
    origBuf=await actx.decodeAudioData(ab); drawWave(origBuf); showOverlay(false); await doProc();
  }catch(e){showOverlay(false);setStatus('','Erro: '+e.message);}
}

/* ‚ïê‚ïê ADMIN UPLOAD ‚ïê‚ïê */
document.getElementById('fileIn').addEventListener('change',e=>{if(e.target.files[0]&&isAdmin)uploadAndBroadcast(e.target.files[0]);});
const dz=document.getElementById('dz');
dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('over');});
dz.addEventListener('dragleave',()=>dz.classList.remove('over'));
dz.addEventListener('drop',e=>{e.preventDefault();dz.classList.remove('over');const f=e.dataTransfer.files[0];if(f&&f.type.startsWith('audio/')&&isAdmin)uploadAndBroadcast(f);});

async function uploadAndBroadcast(file){
  const fn=document.getElementById('fname'); fn.textContent='üéµ '+file.name; fn.style.display='inline-block';
  const bw=document.getElementById('uploadBarWrap'), bar=document.getElementById('uploadBar');
  bw.style.display='block'; bar.style.width='5%';
  pubProg(1,file.name); showOverlay(true,'Enviando...',5); setStatus('proc','Enviando...');
  try{
    const fd=new FormData(); fd.append('file',file); fd.append('upload_preset',CLOUDINARY_PRESET); fd.append('resource_type','video');
    const xhr=new XMLHttpRequest();
    xhr.open('POST',`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD}/video/upload`);
    xhr.upload.onprogress=e=>{if(e.lengthComputable){const p=Math.round(e.loaded/e.total*80);bar.style.width=p+'%';showOverlay(true,`Enviando... ${p}%`,p);pubProg(p,file.name);}};
    const result=await new Promise((res,rej)=>{xhr.onload=()=>xhr.status===200?res(JSON.parse(xhr.responseText)):rej(new Error(xhr.responseText));xhr.onerror=()=>rej(new Error('Rede'));xhr.send(fd);});
    const url=result.secure_url;
    bar.style.width='90%'; pubProg(90,file.name); showOverlay(true,'Notificando...',90);
    await db.ref('session').set({audioUrl:url,audioName:file.name,uploadedBy:displayName,uploadedAt:firebase.database.ServerValue.TIMESTAMP});
    const hk=db.ref('audioHistory').push().key;
    await db.ref('audioHistory/'+hk).set({url,name:file.name,uploadedBy:displayName,uploadedAt:firebase.database.ServerValue.TIMESTAMP,isActive:true});
    const all=(await db.ref('audioHistory').once('value')).val()||{};
    const upd={}; Object.keys(all).forEach(k=>{if(k!==hk)upd['audioHistory/'+k+'/isActive']=false;});
    if(Object.keys(upd).length)await db.ref().update(upd);
    await db.ref('chat').push({type:'system',text:`üéµ ${displayName} enviou: ${file.name}`,ts:firebase.database.ServerValue.TIMESTAMP});
    bar.style.width='100%'; pubProg(100,file.name);
    document.getElementById('uploadStatus').style.display='block'; bw.style.display='none';
    showOverlay(false); clrProg();
    ensureActx(); origBuf=await actx.decodeAudioData(await file.arrayBuffer()); drawWave(origBuf); await doProc();
  }catch(e){clrProg();showOverlay(false);setStatus('','Erro: '+e.message);}
}

/* ‚ïê‚ïê PHASE VOCODER ‚ïê‚ïê */
function fft(re,im,inverse){
  const n=re.length;
  for(let i=1,j=0;i<n;i++){let bit=n>>1;for(;j&bit;bit>>=1)j^=bit;j^=bit;if(i<j){let t=re[i];re[i]=re[j];re[j]=t;t=im[i];im[i]=im[j];im[j]=t;}}
  for(let len=2;len<=n;len<<=1){const ang=2*Math.PI/len*(inverse?1:-1),wr=Math.cos(ang),wi=Math.sin(ang);
    for(let i=0;i<n;i+=len){let cr=1,ci=0;
      for(let k=0;k<len/2;k++){const ur=re[i+k],ui=im[i+k],vr=re[i+k+len/2]*cr-im[i+k+len/2]*ci,vi=re[i+k+len/2]*ci+im[i+k+len/2]*cr;
        re[i+k]=ur+vr;im[i+k]=ui+vi;re[i+k+len/2]=ur-vr;im[i+k+len/2]=ui-vi;const nr=cr*wr-ci*wi;ci=cr*wi+ci*wr;cr=nr;}}}
  if(inverse)for(let i=0;i<n;i++){re[i]/=n;im[i]/=n;}
}
function pvPitchShiftAsync(input,semitones,onProgress){
  return new Promise(resolve=>{
    if(semitones===0){resolve(input.slice());return;}
    const pr=Math.pow(2,semitones/12),N=4096,H=512,hN=N>>1,len=input.length,CHUNK=8;
    const win=new Float32Array(N);for(let i=0;i<N;i++)win[i]=0.5*(1-Math.cos(2*Math.PI*i/N));
    const ep=2*Math.PI*H/N,pa=new Float32Array(hN+1),sp=new Float32Array(hN+1);
    const out=new Float32Array(len+N),wa=new Float32Array(len+N);
    const nf=Math.floor((len-N)/H)+1;let frame=0;
    function tick(){
      const end=Math.min(frame+CHUNK,nf);
      for(;frame<end;frame++){
        const pos=frame*H,re=new Float32Array(N),im=new Float32Array(N);
        for(let i=0;i<N;i++)re[i]=(pos+i<len?input[pos+i]:0)*win[i];
        fft(re,im,false);
        const mag=new Float32Array(hN+1),iF=new Float32Array(hN+1),an=new Float32Array(hN+1);
        for(let k=0;k<=hN;k++){mag[k]=Math.sqrt(re[k]*re[k]+im[k]*im[k]);an[k]=Math.atan2(im[k],re[k]);let dp=an[k]-pa[k]-k*ep;dp-=2*Math.PI*Math.round(dp/(2*Math.PI));iF[k]=k*ep/H+dp/H;pa[k]=an[k];}
        const ip=new Uint8Array(hN+1);for(let k=1;k<hN;k++)if(mag[k]>mag[k-1]&&mag[k]>mag[k+1])ip[k]=1;ip[0]=1;ip[hN]=1;
        const sR=new Float32Array(N),sI=new Float32Array(N),ps=new Float32Array(hN+1);
        for(let k=0;k<=hN;k++){if(!ip[k])continue;sp[k]+=iF[k]*pr*H;ps[k]=sp[k];}
        let pl=0;
        for(let k=0;k<=hN;k++){if(ip[k])pl=k;let pr2=k;for(let p=k;p<=hN;p++){if(ip[p]){pr2=p;break;}}
          const nr=(k-pl<=pr2-k)?pl:pr2,dk=Math.round(k*pr);if(dk<0||dk>hN)continue;
          const dp=Math.round(nr*pr);if(dp<0||dp>hN)continue;
          const ph=ps[nr]+(an[k]-an[nr]);sR[dk]+=mag[k]*Math.cos(ph);sI[dk]+=mag[k]*Math.sin(ph);}
        for(let k=1;k<hN;k++){sR[N-k]=sR[k];sI[N-k]=-sI[k];}
        fft(sR,sI,true);
        for(let i=0;i<N;i++){const oi=pos+i;if(oi<out.length){out[oi]+=sR[i]*win[i];wa[oi]+=win[i]*win[i];}}
      }
      if(onProgress)onProgress(Math.round(frame/nf*100));
      if(frame<nf){setTimeout(tick,0);return;}
      const res=new Float32Array(len);for(let i=0;i<len;i++)res[i]=wa[i]>1e-8?out[i]/wa[i]:0;resolve(res);
    }
    setTimeout(tick,0);
  });
}
async function pitchShift(buf,semitones,onProgress){
  const nc=buf.numberOfChannels,len=buf.length,sr=buf.sampleRate;
  const o=new AudioBuffer({numberOfChannels:nc,length:len,sampleRate:sr});
  for(let c=0;c<nc;c++){const d=await pvPitchShiftAsync(buf.getChannelData(c),semitones,p=>onProgress&&onProgress(Math.round((c/nc+p/100/nc)*100)));o.copyToChannel(d,c);}
  return o;
}

/* ‚ïê‚ïê APP STATE ‚ïê‚ïê */
const NOTES=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
const LABELS=['D√≥','R√©‚ô≠','R√©','Mi‚ô≠','Mi','F√°','Sol‚ô≠','Sol','L√°‚ô≠','L√°','Si‚ô≠','Si'];
const IVLS=[0,4,7];
let actx=null,origBuf=null,pBufs=[null,null,null];
let keyIdx=0,octs=[0,0,0],vols=[1.0,0.8,0.8];
let srcs=[null,null,null],gNodes=[null,null,null];

(function(){
  const kg=document.getElementById('kg');
  NOTES.forEach((n,i)=>{
    const b=document.createElement('button');
    b.className='kbtn'+(i===0?' active':'');
    b.innerHTML=`<span class="n">${n}</span>`;
    b.title=LABELS[i];
    b.onclick=()=>{keyIdx=i;document.querySelectorAll('.kbtn').forEach((x,j)=>x.classList.toggle('active',j===i));refreshInfo();if(origBuf)schedProc();};
    kg.appendChild(b);
  });
})();

function refreshInfo(){
  const semis=IVLS.map((iv,i)=>keyIdx+iv+octs[i]*12);
  [0,1,2].forEach(i=>{
    document.getElementById('nd'+i).textContent=NOTES[((keyIdx+IVLS[i])%12+12)%12];
    document.getElementById('st'+i).textContent=(semis[i]>=0?'+':'')+semis[i]+' st';
  });
  const [r,t,f]=[NOTES[keyIdx],NOTES[(keyIdx+4)%12],NOTES[(keyIdx+7)%12]];
  document.getElementById('theory').textContent=`${r} fundamental ‚Üí ${t} 3¬™ maior (+4st) ‚Üí ${f} 5¬™ justa (+7st)`;
}

const slC=['var(--accent)','var(--accent2)','var(--accent3)'];
[0,1,2].forEach(ch=>{
  const sl=document.getElementById('v'+ch);
  const upd=()=>{
    vols[ch]=sl.value/100;
    document.getElementById('vd'+ch).textContent=sl.value+'%';
    const p=(sl.value/150*100).toFixed(1);
    sl.style.background=`linear-gradient(to right,${slC[ch]} ${p}%,var(--border) ${p}%)`;
    if(gNodes[ch]&&actx)gNodes[ch].gain.setTargetAtTime(vols[ch],actx.currentTime,0.01);
  };
  sl.addEventListener('input',upd); upd();
});

/* ‚ïê‚ïê PLAY / STOP ‚ïê‚ïê */
let isPlaying=false;
function setPlayState(p){
  isPlaying=p;
  const btn=document.getElementById('playAllBtn');
  if(p){btn.textContent='‚ñ† Parar Tudo';btn.style.background='linear-gradient(135deg,var(--red),#c0392b)';btn.style.boxShadow='0 6px 30px rgba(240,96,96,.38)';}
  else{btn.textContent='‚ñ∂‚ñ∂ Tocar Tudo';btn.style.background='linear-gradient(135deg,var(--accent),var(--accent2))';btn.style.boxShadow='0 6px 30px rgba(124,92,252,.38)';}
}
document.getElementById('playAllBtn').onclick=()=>{if(isPlaying)stopAll();else{[0,1,2].forEach(playCh);setPlayState(true);}};
document.getElementById('stopBtn').onclick=stopAll;
document.getElementById('expBtn').onclick=exportMix;

function ensureActx(){if(!actx||actx.state==='closed')actx=new(window.AudioContext||window.webkitAudioContext)();if(actx.state==='suspended')actx.resume();}
function playCh(ch){
  if(!pBufs[ch])return; stopCh(ch); ensureActx();
  const s=actx.createBufferSource(); s.buffer=pBufs[ch];
  const g=actx.createGain(); g.gain.value=vols[ch];
  s.connect(g); g.connect(actx.destination); s.start();
  srcs[ch]=s; gNodes[ch]=g;
  s.onended=()=>{srcs[ch]=null;gNodes[ch]=null;if(srcs.every(x=>x===null))setPlayState(false);};
}
function stopCh(ch){if(srcs[ch]){try{srcs[ch].stop();}catch(e){}try{if(gNodes[ch])gNodes[ch].disconnect();}catch(e){}srcs[ch]=null;gNodes[ch]=null;}}
function stopAll(){[0,1,2].forEach(stopCh);setPlayState(false);}

let procTimer=null;
function schedProc(){clearTimeout(procTimer);procTimer=setTimeout(doProc,300);}
async function doProc(){
  if(!origBuf)return; stopAll();
  const semis=IVLS.map((iv,i)=>keyIdx+iv+octs[i]*12);
  const lbls=['Fundamental','3¬™ Maior','5¬™ Justa'];
  try{
    for(let i=0;i<3;i++){
      showOverlay(true,`Gerando ${lbls[i]}...`,Math.round(i/3*100));
      pBufs[i]=await pitchShift(origBuf,semis[i],p=>showOverlay(true,`${lbls[i]}... ${p}%`,Math.round((i/3+p/300)*100)));
    }
    showOverlay(false,'',100);
    document.getElementById('playAllBtn').disabled=false;
    document.getElementById('expBtn').disabled=false;
    setStatus('ok','‚úì Fundamental ¬∑ 3¬™ ¬∑ 5¬™ prontas');
  }catch(e){showOverlay(false);setStatus('','Erro: '+e.message);}
  refreshInfo();
}

function showOverlay(show,txt='',pct=0){
  document.getElementById('overlay').classList.toggle('show',show);
  if(txt)document.getElementById('ptxt').textContent=txt;
  const p=Math.min(100,Math.max(0,pct));
  document.getElementById('pbar').style.width=p+'%';
  document.getElementById('pct').textContent=p<100?p+'%':'';
}
function setStatus(cls,msg){
  const ids=isAdmin?['status']:['status','status2'];
  ids.forEach(id=>{
    const el=document.getElementById(id); if(!el)return;
    el.className='sbar '+cls;
    el.innerHTML=`<span class="dot"></span><span>${msg}</span>`;
  });
}
function drawWave(buf){
  const ids=isAdmin?['ww','wvc']:['ww2','wvc2'];
  const ww=document.getElementById(ids[0]),cv=document.getElementById(ids[1]);
  ww.style.display='block';
  cv.width=ww.clientWidth*devicePixelRatio; cv.height=ww.clientHeight*devicePixelRatio;
  const ctx=cv.getContext('2d'); ctx.scale(devicePixelRatio,devicePixelRatio);
  const W=ww.clientWidth,H=ww.clientHeight,data=buf.getChannelData(0),step=Math.ceil(data.length/W);
  const g=ctx.createLinearGradient(0,0,W,0);
  g.addColorStop(0,'rgba(124,92,252,.9)');g.addColorStop(.5,'rgba(252,92,156,.9)');g.addColorStop(1,'rgba(62,232,194,.9)');
  ctx.strokeStyle=g; ctx.lineWidth=1.5; ctx.beginPath();
  for(let x=0;x<W;x++){let mn=1,mx=-1;for(let s=0;s<step;s++){const v=data[(x*step+s)%data.length];if(v<mn)mn=v;if(v>mx)mx=v;}ctx.moveTo(x,H/2+mn*H*.44);ctx.lineTo(x,H/2+mx*H*.44);}
  ctx.stroke();
}
async function exportMix(){
  if(!pBufs[0])return; showOverlay(true,'Mixando...',50);
  const len=pBufs[0].length,sr=pBufs[0].sampleRate,off=new OfflineAudioContext(2,len,sr);
  [0,1,2].forEach(ch=>{if(!pBufs[ch])return;const s=off.createBufferSource();s.buffer=pBufs[ch];const g=off.createGain();g.gain.value=vols[ch];s.connect(g);g.connect(off.destination);s.start();});
  const mix=await off.startRendering();
  const wav=toWav(mix), url=URL.createObjectURL(new Blob([wav],{type:'audio/wav'}));
  Object.assign(document.createElement('a'),{href:url,download:'harmonia_mix.wav'}).click();
  URL.revokeObjectURL(url); showOverlay(false);
}
function toWav(buf){
  const nc=buf.numberOfChannels,len=buf.length,sr=buf.sampleRate;
  const ab=new ArrayBuffer(44+len*nc*2),dv=new DataView(ab);
  const ws=(o,s)=>{for(let i=0;i<s.length;i++)dv.setUint8(o+i,s.charCodeAt(i));};
  ws(0,'RIFF');dv.setUint32(4,36+len*nc*2,true);ws(8,'WAVE');ws(12,'fmt ');dv.setUint32(16,16,true);dv.setUint16(20,1,true);
  dv.setUint16(22,nc,true);dv.setUint32(24,sr,true);dv.setUint32(28,sr*nc*2,true);dv.setUint16(32,nc*2,true);dv.setUint16(34,16,true);
  ws(36,'data');dv.setUint32(40,len*nc*2,true);
  let o=44;
  for(let i=0;i<len;i++)for(let c=0;c<nc;c++){const s=Math.max(-1,Math.min(1,buf.getChannelData(c<buf.numberOfChannels?c:0)[i]));dv.setInt16(o,s<0?s*0x8000:s*0x7FFF,true);o+=2;}
  return ab;
}

refreshInfo();
</script>
</body>
</html>
